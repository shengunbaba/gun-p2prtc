<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Peer2Peer</title>
    <link rel="stylesheet" href="./style.css">
    <script src="./p2pRTC.min.js"></script>
</head>
<body>
<ul class="connect-panel">
    <li>
        <label for="localInput">local:</label>
        <input type="text" id="localInput">
    </li>
    <li>
        <label for="remoteInput">remote:</label>
        <input type="text" id="remoteInput">
    </li>
    <li class="connect" onclick="onConnect()">connect</li>
</ul>
<div class="message-wrap">
    <div class="send">
        <button id="sendBtn">send</button>
        <textarea name="" id="sendText" cols="30" rows="5" placeholder="send message..."></textarea>
    </div>
    <div id="receiveMessage">receive message...</div>
</div>
<div class="video-panel">
    <span onclick="onSwitchAudio()" class="switch-audio">close audio</span>
    <span onclick="onSwitchVideo()" class="switch-video">close video</span>
    <span onclick="onleave()">leave</span>
</div>
<div class="video-wrap">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
</div>


<script>
    const localInput = document.getElementById('localInput');
    const remoteInput = document.getElementById('remoteInput');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const connectPanel = document.querySelector('.connect-panel');
    const videoPanel = document.querySelector('.video-panel');

    const receiveMessage = document.getElementById('receiveMessage');
    const sendText = document.getElementById('sendText');
    const sendBtn = document.getElementById('sendBtn');

    let peer,
        ws,
        dataChannelStatus,
        audioStatus = true,
        videoStatus = true;
    localInput.value = (Math.random() * 1000 * 0x10000).toString(16).slice(0, 4);

    const onConnect = () => {
        ws = new WebSocket('wss://localhost:8080');

        const option = {};
        if (remoteInput.value) {
            option.initiator = true;
        }
        peer = new Peer2peer(option);
        peer.addEventListener('localStream', data => {
            localVideo.srcObject = data.stream;
        });

        peer.addEventListener('offer', offer => {
            ws.send(JSON.stringify(offer));
        });
        peer.addEventListener('answer', answer => {
            ws.send(JSON.stringify(answer));
            setTimeout(() => peer.getStats().then(data => console.log(data)), 2000);

        });
        peer.addEventListener('icecandidate', event => {
            if (event.candidate) ws.send(JSON.stringify({type: 'icecandidate', candidate: event.candidate}));
        });
        peer.addEventListener('remoteStream', event => {
            remoteVideo.srcObject = event.stream;
        });

        peer.addEventListener('dataChannel-ready', () => {
            dataChannelStatus = true;
        });

        peer.addEventListener('message', (event) => {
            receiveMessage.innerText = event.data;
        });

        ws.addEventListener('message', (event) => {
            const data = JSON.parse(event.data);
            switch (data.type) {
                case 'ready':
                    connectPanel.style.display = 'none';
                    videoPanel.style.display = 'flex';
                    peer.signal('ready');
                    break;
                case 'offer':
                    peer.signal(data);
                    break;
                case 'answer':
                    peer.signal(data);
                    break;
                case 'icecandidate':
                    peer.signal(data);
                    break;
            }
        });
    };

    const onSwitchAudio = () => {
        const promise = audioStatus ? peer.mute('audio') : peer.unmute('audio');
        promise.then(() => {
            audioStatus = !audioStatus;
            document.querySelector('.switch-audio').innerHTML = audioStatus ? 'close audio' : 'open audio';
        });
    };

    const onSwitchVideo = () => {
        const promise = videoStatus ? peer.mute('video') : peer.unmute('video');
        promise.then(() => {
            videoStatus = !videoStatus;
            document.querySelector('.switch-video').innerHTML = videoStatus ? 'close video' : 'open video';
        });
    };

    sendBtn.addEventListener('click', () => {
        if (dataChannelStatus) {
            peer.send(sendText.value);
        }
    });

    const onleave = () => {
        peer.leave();
        location.reload();
    };
</script>
</body>
</html>
